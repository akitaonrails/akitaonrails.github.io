<!-- Disqus -->
{{- with .Site.Config.Services.Disqus.Shortname }}
{{- $shortname := . }}
<div id="disqus_thread"></div>
<script>
    function getDisqusConfig() {
        var isDark = document.documentElement.classList.contains('dark');
        return function () {
            this.page.url = '{{ $.Page.Permalink }}';
            this.page.identifier = '{{ $.Page.RelPermalink }}';
            this.page.colorScheme = isDark ? 'dark' : 'light';
        };
    }

    var disqus_config = getDisqusConfig();

    (function() {
        var d = document, s = d.createElement('script');
        s.src = 'https://{{ $shortname }}.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();

    // Reload Disqus when theme changes (light/dark toggle)
    (function() {
        var lastTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';

        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.attributeName === 'class') {
                    var currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                    if (currentTheme !== lastTheme) {
                        lastTheme = currentTheme;
                        if (typeof DISQUS !== 'undefined') {
                            DISQUS.reset({
                                reload: true,
                                config: getDisqusConfig()
                            });
                        }
                    }
                }
            });
        });

        observer.observe(document.documentElement, { attributes: true });
    })();
</script>
<noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">
        comments powered by Disqus.
    </a>
</noscript>
{{ end }}
